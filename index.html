<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Editor Foto RSDS</title>
  <style>
    body { font-family: sans-serif; padding: 20px; }
    #map { width: 100%; height: 300px; margin-top: 10px; }
    #canvas { display: none; }
    #preview img { max-width: 100%; margin-top: 10px; }
  </style>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
</head>
<body>
  <h2>Editor Foto RSDS</h2>
  <input type="file" id="photoInput"><br><br>
  <input type="text" id="caption" placeholder="Keterangan"><br><br>
  <input type="datetime-local" id="datetime"><br><br>
  <button id="getLocationBtn">üìç Gunakan Lokasi Saya Sekarang</button><br><br>
  <div id="map"></div><br>
  <button id="exportBtn">Export Gambar</button>
  <canvas id="canvas"></canvas>
  <div id="preview"></div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script>
let selectedLatLng = null;
let resizedImg = null;
let locationName = "";
const logo = new Image();
logo.src = "data:image/png;base64,PASTE_LOGO_BASE64_HERE"; // Ganti dengan base64 logo RSDS

async function getLocationName(lat, lon) {
  try {
    const res = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}`);
    const data = await res.json();
    return data.display_name || "";
  } catch {
    return "";
  }
}

function toDMS(deg, isLat) {
  const absolute = Math.abs(deg);
  const degrees = Math.floor(absolute);
  const minutes = Math.floor((absolute - degrees) * 60);
  const seconds = Math.floor(((absolute - degrees) * 60 - minutes) * 60);
  const direction = deg >= 0 ? (isLat ? "N" : "E") : (isLat ? "S" : "W");
  return `${degrees}¬∞${minutes}'${seconds}" ${direction}`;
}

function resizeImage(image, maxWidth = 1280) {
  const scale = maxWidth / image.width;
  const width = image.width * scale;
  const height = image.height * scale;
  const offscreen = document.createElement('canvas');
  offscreen.width = width;
  offscreen.height = height;
  const ctx = offscreen.getContext('2d');
  ctx.drawImage(image, 0, 0, width, height);
  const resized = new Image();
  resized.src = offscreen.toDataURL();
  return new Promise((resolve) => {
    resized.onload = () => resolve(resized);
  });
}

document.getElementById("photoInput").addEventListener("change", async (e) => {
  const file = e.target.files[0];
  const reader = new FileReader();
  reader.onload = async function(event) {
    const img = new Image();
    img.onload = async function() {
      resizedImg = await resizeImage(img);
    };
    img.src = event.target.result;
  };
  reader.readAsDataURL(file);
});

const map = L.map('map').setView([-7.2575, 112.7521], 17);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
let marker;
map.on('click', function(e) {
  selectedLatLng = e.latlng;
  if (marker) marker.setLatLng(e.latlng);
  else marker = L.marker(e.latlng).addTo(map);
  getLocationName(e.latlng.lat, e.latlng.lng).then(name => locationName = name);
});

document.getElementById("getLocationBtn").addEventListener("click", () => {
  if (navigator.geolocation) {
    navigator.geolocation.getCurrentPosition((position) => {
      const lat = position.coords.latitude;
      const lng = position.coords.longitude;
      selectedLatLng = L.latLng(lat, lng);
      map.setView(selectedLatLng, 17);
      if (marker) marker.setLatLng(selectedLatLng);
      else marker = L.marker(selectedLatLng).addTo(map);
      getLocationName(lat, lng).then(name => locationName = name);
    }, () => alert("Gagal mendapatkan lokasi."));
  } else {
    alert("Browser tidak mendukung geolocation.");
  }
});

document.getElementById("exportBtn").addEventListener("click", async () => {
  if (!resizedImg) return alert("Upload foto dulu!");
  const canvas = document.getElementById("canvas");
  canvas.width = resizedImg.width;
  canvas.height = resizedImg.height;
  const ctx = canvas.getContext("2d");
  ctx.clearRect(0, 0, canvas.width, canvas.height);
  ctx.drawImage(resizedImg, 0, 0);
  await new Promise(resolve => logo.complete ? resolve() : logo.onload = resolve);
  const shortest = Math.min(resizedImg.width, resizedImg.height);
  const logoSize = shortest * 0.2;
  ctx.drawImage(logo, 20, 20, logoSize, logoSize);

  const fontSize = Math.floor(logoSize * 0.05);
  ctx.font = `${fontSize}px Arial`;
  ctx.fillStyle = "white";
  ctx.strokeStyle = "black";
  ctx.lineWidth = 2;

  const caption = document.getElementById("caption").value || "Tanpa Keterangan";
  const dtInput = document.getElementById("datetime").value || new Date().toLocaleString();
  const latlng = selectedLatLng || L.latLng(-7.2575, 112.7521);
  const dmsLat = toDMS(latlng.lat, true);
  const dmsLng = toDMS(latlng.lng, false);
  const geotagText = `${dmsLat}, ${dmsLng} (¬±5m)`;

  const overlayHeight = 200;
  ctx.fillStyle = "rgba(0, 0, 0, 0.2)";
  ctx.fillRect(0, canvas.height - overlayHeight, canvas.width, overlayHeight);

  let x = 30;
  let y = canvas.height - overlayHeight + 40;

  if (locationName) {
    ctx.strokeText(locationName, x, y);
    ctx.fillText(locationName, x, y);
    y += fontSize + 10;
  }

  ctx.strokeText(geotagText, x, y);
  ctx.fillText(geotagText, x, y);
  y += fontSize + 10;

  ctx.strokeText(dtInput, x, y);
  ctx.fillText(dtInput, x, y);
  y += fontSize + 10;

  const wrapText = (ctx, text, x, y, maxWidth, lineHeight, maxLines = 2) => {
    const words = text.split(' ');
    let line = '';
    let lines = [];
    for (let n = 0; n < words.length; n++) {
      const testLine = line + words[n] + ' ';
      const metrics = ctx.measureText(testLine);
      const testWidth = metrics.width;
      if (testWidth > maxWidth && n > 0) {
        lines.push(line.trim());
        line = words[n] + ' ';
        if (lines.length === maxLines - 1) break;
      } else {
        line = testLine;
      }
    }
    lines.push(line.trim());
    lines.forEach((l, i) => {
      ctx.strokeText(l, x, y + i * lineHeight);
      ctx.fillText(l, x, y + i * lineHeight);
    });
  };

  wrapText(ctx, caption, x, y, canvas.width - 60, fontSize + 6);

  const img = new Image();
  img.src = canvas.toDataURL("image/png");
  document.getElementById("preview").innerHTML = "";
  document.getElementById("preview").appendChild(img);
});
</script>
</body>
</html>
